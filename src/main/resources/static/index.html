<!doctype html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Bild zu PDF</title>

    <!-- Google Material Design Lite -->
    <link rel="stylesheet"
          href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- Roboto + Icons -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .page-container {
            max-width: 600px;
            margin: 40px auto;
        }
        .hidden {
            display: none;
        }
        .file-name {
            margin-left: 8px;
            font-size: 0.9rem;
            color: #555;
        }
        .center {
            text-align: center;
        }
        .top-space {
            margin-top: 24px;
        }
    </style>
</head>
<body class="mdl-color--grey-100">

<div class="page-container">
    <div class="mdl-card mdl-shadow--4dp mdl-color--white" style="width: 100%;">
        <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">Bild zu PDF konvertieren</h2>
        </div>
        <div class="mdl-card__supporting-text">
            <p>Wähle ein Bild (PNG/JPEG) aus. Es wird hochgeladen, im Hintergrund
                zu einem PDF konvertiert und du bekommst danach einen Link.</p>

            <form id="uploadForm">
                <!-- verstecktes File-Input -->
                <input type="file" id="fileInput" name="file" accept="image/*" class="hidden" required>

                <button type="button"
                        id="chooseFileBtn"
                        class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                    <i class="material-icons">file_upload</i>
                    Datei auswählen
                </button>
                <span id="fileName" class="file-name">Keine Datei ausgewählt</span>

                <div class="top-space center">
                    <button type="submit"
                            id="submitBtn"
                            class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent"
                            disabled>
                        <i class="material-icons">play_arrow</i>
                        Hochladen &amp; konvertieren
                    </button>
                </div>
            </form>

            <!-- Upload-Status -->
            <div id="statusText" class="top-space center hidden">
                <p>Upload läuft…</p>
            </div>

            <!-- Material Design Progress-Bar -->
            <div id="progressContainer" class="hidden">
                <div id="uploadProgress"
                     class="mdl-progress mdl-js-progress mdl-progress__indeterminate">
                </div>
            </div>

            <div id="errorBox" class="top-space mdl-color--red-50 mdl-shadow--2dp hidden"
                 style="padding: 12px; border-radius: 4px;">
                <strong>Fehler:</strong>
                <span id="errorMessage"></span>
            </div>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const chooseFileBtn = document.getElementById('chooseFileBtn');
    const fileNameSpan = document.getElementById('fileName');
    const submitBtn = document.getElementById('submitBtn');
    const progressContainer = document.getElementById('progressContainer');
    const statusText = document.getElementById('statusText');
    const errorBox = document.getElementById('errorBox');
    const errorMessage = document.getElementById('errorMessage');

    chooseFileBtn.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileNameSpan.textContent = fileInput.files[0].name;
            submitBtn.disabled = false;
        } else {
            fileNameSpan.textContent = 'Keine Datei ausgewählt';
            submitBtn.disabled = true;
        }
    });

    document.getElementById('uploadForm').addEventListener('submit', function (e) {
        e.preventDefault();
        errorBox.classList.add('hidden');

        if (fileInput.files.length === 0) {
            return;
        }

        // Progress-Bar sichtbar machen
        progressContainer.classList.remove('hidden');
        statusText.classList.remove('hidden');
        statusText.querySelector('p').textContent = 'Upload läuft…';

        // MDL-Progress initialisieren
        const progressBar = document.getElementById('uploadProgress');
        if (progressBar.MaterialProgress) {
            progressBar.MaterialProgress.setProgress(0);
            progressBar.classList.remove('mdl-progress__indeterminate');
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/convert', true);

        // Fortschritt während des Uploads
        xhr.upload.addEventListener('progress', function (event) {
            if (event.lengthComputable && progressBar.MaterialProgress) {
                const percent = (event.loaded / event.total) * 100;
                progressBar.MaterialProgress.setProgress(percent);
            } else {
                // Fallback: unbestimmte Animation
                progressBar.classList.add('mdl-progress__indeterminate');
            }
        });

        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                // 303 / 202 / 200 – alles im 2xx/3xx Bereich ok
                if (xhr.status >= 200 && xhr.status < 400) {
                    statusText.querySelector('p').textContent = 'Upload abgeschlossen. Weiterleiten…';

                    // final URL (nach Redirect) verwenden
                    const targetUrl = xhr.responseURL || '/';
                    window.location.href = targetUrl;
                } else {
                    progressContainer.classList.add('hidden');
                    statusText.classList.add('hidden');
                    errorMessage.textContent = 'Upload fehlgeschlagen (Status ' + xhr.status + ').';
                    errorBox.classList.remove('hidden');
                }
            }
        };

        xhr.send(formData);
    });
</script>

</body>
</html>
